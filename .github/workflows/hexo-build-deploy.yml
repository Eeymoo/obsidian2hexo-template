name: hexo-build-deploy
on:
  push:
    branches:
      - main
    paths:
      - '_config.yml'
      - 'themes/**'
      - 'source/**'
      - 'package.json'
      - '.github/workflows/**'
  repository_dispatch:
      types:
        - obsidian-content-update

env:
  OBSIDIAN_REPO: Eeymoo/Obsidian
  BLOG_PAGES_REPO: Eeymoo/Eeymoo.github.io  # 目标Pages仓库
  BLOG_PAGES_BRANCH: main                   # Pages仓库的部署分支（默认用main）
  NODE_VERSION: '18'
  OBSIDIAN_CONTENT_PATH: '博客'

jobs:
  generate-static-files:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Hexo Template
        uses: actions/checkout@v4
        with:
          path: hexo-template
          fetch-depth: 0

      - name: Checkout Obsidian Docs
        uses: actions/checkout@v4
        with:
          repository: ${{ env.OBSIDIAN_REPO }}
          path: obsidian-doc
          fetch-depth: 0
          token: ${{ secrets.SERVICE_ACCOUNT_KEY }}

      - name: Set up Node.js & Cache Dependencies
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: hexo-template/package-lock.json

      - name: Move Obsidian Content to Hexo
        run: |
          mkdir -p hexo-template/source/_posts
          if [ -d "obsidian-doc/${{ env.OBSIDIAN_CONTENT_PATH }}" ]; then
            mv obsidian-doc/${{ env.OBSIDIAN_CONTENT_PATH }}/* hexo-template/source/_posts/
            echo "成功移动Obsidian博客内容"
          else
            echo "Obsidian博客目录不存在，跳过移动"
          fi

      - name: Install Hexo & Generate Static Files
        run: |
          cd hexo-template
          npm install --no-fund --no-audit
          npm install -g hexo-cli
          hexo clean
          hexo generate

      - name: Prepare Static Files
        run: |
          mkdir -p blog
          mv hexo-template/public/* blog/
          ls -a blog

      # 上传静态文件作为Artifact，供部署任务使用
      - name: Upload Static Files Artifact
        uses: actions/upload-artifact@v4
        with:
          name: blog-static-files
          path: blog/
          retention-days: 1

  # 关键修改：改用Git Push部署到独立的Pages仓库
  deploy-to-pages:
    needs: generate-static-files
    runs-on: ubuntu-latest
    steps:
      # 步骤1：下载生成的静态文件
      - name: Download Static Files
        uses: actions/download-artifact@v4
        with:
          name: blog-static-files
          path: blog

      # 步骤2：拉取目标Pages仓库（Eeymoo.github.io）
      - name: Checkout Pages Repository
        uses: actions/checkout@v4
        with:
          repository: ${{ env.BLOG_PAGES_REPO }}
          path: pages-repo
          ref: ${{ env.BLOG_PAGES_BRANCH }}  # 切换到部署分支
          token: ${{ secrets.SERVICE_ACCOUNT_KEY }}  # 授权推送

      # 步骤3：将静态文件覆盖到Pages仓库
      - name: Copy Static Files to Pages Repo
        run: |
          rm -rf pages-repo/*  # 清空旧文件（避免冗余）
          cp -r blog/* pages-repo/  # 复制新生成的静态文件

      # 步骤4：提交并推送到Pages仓库
      - name: Push to Pages Repository
        working-directory: pages-repo
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add .
          # 容错：如果没有变更，避免提交失败
          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          git commit -m "Deploy blog: $(date +'%Y-%m-%d %H:%M:%S')"
          git push origin ${{ env.BLOG_PAGES_BRANCH }}