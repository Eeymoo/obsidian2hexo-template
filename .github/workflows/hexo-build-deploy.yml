name: hexo-build-deploy
# Hexo模板仓库主流程：拉取Obsidian内容 → 生成静态文件 → 部署到Github Pages
on:
  push:
    branches:
      - main
    paths:
      - '_config.yml'
      - 'themes/**'
      - 'source/**'
      - 'package.json'
      - '.github/workflows/**'
  repository_dispatch:
      types:
        - obsidian-content-update

env:
  OBSIDIAN_REPO: Eeymoo/Obsidian
  BLOG_PAGES_REPO: Eeymoo/Eeymoo.github.io
  NODE_VERSION: '18'
  OBSIDIAN_CONTENT_PATH: '博客'

jobs:
  generate-static-files:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Hexo Template
        uses: actions/checkout@v4
        with:
          path: hexo-template
          fetch-depth: 0

      - name: Checkout Obsidian Docs
        uses: actions/checkout@v4
        with:
          repository: ${{ env.OBSIDIAN_REPO }}
          path: obsidian-doc
          fetch-depth: 0
          token: ${{ secrets.SERVICE_ACCOUNT_KEY }}

      - name: Set up Node.js & Cache Dependencies
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: hexo-template/package-lock.json

      - name: Move Obsidian Content to Hexo
        run: |
          mkdir -p hexo-template/source/_posts
          if [ -d "obsidian-doc/${{ env.OBSIDIAN_CONTENT_PATH }}" ]; then
            mv obsidian-doc/${{ env.OBSIDIAN_CONTENT_PATH }}/* hexo-template/source/_posts/
            echo "成功移动Obsidian博客内容"
          else
            echo "Obsidian博客目录不存在，跳过移动"
          fi

      - name: Install Hexo & Generate Static Files
        run: |
          cd hexo-template
          npm install --no-fund --no-audit
          npm install -g hexo-cli
          hexo clean
          hexo generate

      - name: Prepare Static Files
        run: |
          mkdir -p blog
          mv hexo-template/public/* blog/
          ls -a blog

      # 关键修改1：将artifact名称改为github-pages（符合deploy-pages@v4的默认要求）
      - name: Upload GitHub Pages Artifact
        uses: actions/upload-artifact@v4
        with:
          name: github-pages  # 必须是这个名称，不能自定义
          path: blog/         # 部署文件的目录
          retention-days: 1

  deploy-to-pages:
    needs: generate-static-files
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      # 关键修改2：无需手动下载artifact！deploy-pages@v4会自动拉取名为github-pages的artifact
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        # 移除了错误的folder参数，该Action不需要任何额外参数（仅需默认配置）